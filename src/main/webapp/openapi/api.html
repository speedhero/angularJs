<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <title>Open API</title>
    <link rel="stylesheet" href="../Content/bootstrap.min.css" />
    <style>
        table td{
            max-width: 200px;
            word-break: break-all;
        }
        .paramsUl{
            list-style:none;
            margin:0 0 10px;
        } 
    </style>
</head>
<body style="padding-top:51px">
<div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="row-fluid">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse"
                    data-target=".navbar-collapse">
                    <span class="sr-only">Toggle navigation</span> <span
                        class="icon-bar"></span> <span class="icon-bar"></span> <span
                        class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="javascript:;">Open API
              <!-- <span id="sysInfo" title="当前环境" style="margin-left:5px;font-weight:700;color:white;"></span> -->
              <span id="sysBuildTime" title="Deploy时间" style="font-size:10px;margin-left:5px;color:#999;"></span>
            </a>
        </div>
        <div class="collapse navbar-collapse" id="menu">
        </div>
    </div>
</div>
<div class="row-fluid" id="main">
</div>

<!-- script  -->
<script type="text/javascript" src="../Scripts/jquery-1.11.1.js"></script>
<script type="text/javascript" src="../Scripts/bootstrap.min.js"></script>
<script type="text/javascript" src="../Scripts/underscore-min.js"></script>
<script type="text/javascript">
    $.ajax({
        url: '/openapi/openAPI.do',
        dataType: 'JSON',
        success: function (json) {
            jData = json.api;
            //if(json.sysInfo) document.getElementById("sysInfo").innerText = "(" + json.sysInfo + ")";
            if(json.sysBuildTime) document.getElementById("sysBuildTime").innerText = "Deploy At ：" + json.sysBuildTime;
            
            var tpl = _.template($("#tplMenu").html()) , data = {arr: jData};
            $('#menu')
                .html( tpl( data ) )
                .on('click','li',function(){
                    var _this = $(this)
                        ,itemName = _this.attr('name');
                    fGetContent(itemName, jData);
                    _this.addClass('active')
                        .siblings().removeClass('active')
                    $("body" ).scrollTop(0)
                });
        }
    });

    function fGetContent(key, jData) {
        var tpl = _.template( $( "#tplTable" ).html() )
                , _data = {
                    data: jData[key]
                }
            ;
        // 干掉不用显示的属性
        _.each(_data.data, function(item, i){
            delete item.category;
        })
        $("#main").html(tpl(_data));
    }

    function getTh(item) {
        return _.template($("#tplTh").html(), {obj: item} )
    }

    function getTd(item, i) {
        return _.template($("#tplTd").html(), {obj: item, index:i} )
    }

    function fillColor(text, className){
        return '<span class="' + className + '">'+ text +'</span>'
    }

    function parseTd(obj, name) {
        var _str = ''
                ;
        switch (name.toUpperCase()) {
            case 'NAME':
                _str = fillColor(obj, 'text-success')
                break;
            case 'URL':
                if (_.isArray(obj)) {
                    _.each( obj, function (item, i) {
                        _str += '<p>'+ aHref(obj[i], obj[i]) + '</p>';
                    } )
                }
                break;
            case 'APIRETURN':  
                obj.description = "";
                obj.name = "return"; 
                _str = _.template($("#tplParams").html(), obj); 
                break;
            case 'PARAM':
                if(_.isArray(obj)){
                    var a = [];
                    _.each(obj, function(items, i){
                        a.push(_.template($("#tplParams").html(), items))
                    })
                    _str = a.join("");
                }
                break;
            default:
                _str = obj.toString().replace(/,/g, '<br />');
                break;
        }
        return _str
    } 
     
    function aHrefForMenu(text, href){
        var href = href ? href : "javascript:;";
        return '<a href="' + href + '">' + text + '</a>'
    }
    function aHref(text, href){
        var href = href ? href : "javascript:;";
        return '<a href="' + href + '" target="_blank">' + text + '</a>'
    }
    
    function formatClassName(className,isCollection,isValueObject ){
        if(isValueObject){
            className = '<a href="vo.html?className='+ className +'" target="_blank">'+ className + '</a>'
        }       
        if(isCollection){
            className = '[ '+ className + ' ]'
        }
        return className
    }
    
    
</script>
</body>
</html> 
<script type="text/template" id="tplParams">
    <ul class="paramsUl">
        <li class="text-success"><%= description %></li>
        <li><%= name %>:<% print(formatClassName(className,isCollection,isValueObject)) %></li>
    </ul>
</script>

<script type="text/template" id="tplTh">
    <tr>
        <th>&nbsp;#&nbsp;</th>
        <% _.each(obj, function(item, i){ %>
        <th><%= i %></th>
        <% }) %>
    </tr>
</script>

<script type="text/template" id="tplTd">
    <tr>
        <td><%= index %></td>
        <% _.each(obj, function(item, i){ %>
            <td><%= parseTd(item, i) %></td>
        <% }) %>
    </tr>
</script>

<script type="text/template" id="tplTable">
    <table class="table table-striped table-bordered table-condensed">
        <%
            _.each(data, function(item, i){
                if(i==0){
                    print(getTh(item))
                }
                print(getTd(item, i))                
            })
        %>
    </table>
</script>

<script type="text/template" id="tplMenu">
    <ul class="nav navbar-nav">
        <% _.each(arr, function(item, i){ %>
        <li name="<%= i %>"><%= aHrefForMenu(i) %></li>
        <% }) %>
    </ul>
</script>